function cov_x511qlpzq(){var path="C:\\Users\\euler\\OneDrive\\\u684C\u9762\\3813\\week4\\server\\router\\uploads.js";var hash="4cc0b7fa956af38d60aa4756b6c8d567e788868b";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"C:\\Users\\euler\\OneDrive\\\u684C\u9762\\3813\\week4\\server\\router\\uploads.js",statementMap:{"0":{start:{line:1,column:0},end:{line:46,column:1}},"1":{start:{line:2,column:2},end:{line:45,column:5}},"2":{start:{line:3,column:4},end:{line:3,column:27}},"3":{start:{line:4,column:15},end:{line:4,column:44}},"4":{start:{line:5,column:25},end:{line:5,column:57}},"5":{start:{line:6,column:4},end:{line:6,column:34}},"6":{start:{line:7,column:4},end:{line:7,column:31}},"7":{start:{line:8,column:4},end:{line:44,column:7}},"8":{start:{line:10,column:20},end:{line:10,column:43}},"9":{start:{line:11,column:20},end:{line:11,column:78}},"10":{start:{line:12,column:6},end:{line:43,column:9}},"11":{start:{line:14,column:23},end:{line:14,column:44}},"12":{start:{line:15,column:8},end:{line:22,column:9}},"13":{start:{line:16,column:10},end:{line:16,column:49}},"14":{start:{line:17,column:10},end:{line:21,column:13}},"15":{start:{line:23,column:23},end:{line:26,column:9}},"16":{start:{line:27,column:8},end:{line:42,column:9}},"17":{start:{line:28,column:21},end:{line:28,column:77}},"18":{start:{line:29,column:31},end:{line:34,column:11}},"19":{start:{line:35,column:10},end:{line:39,column:13}},"20":{start:{line:41,column:10},end:{line:41,column:39}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:1,column:17},end:{line:1,column:18}},loc:{start:{line:1,column:62},end:{line:46,column:1}},line:1},"1":{name:"(anonymous_1)",decl:{start:{line:2,column:28},end:{line:2,column:29}},loc:{start:{line:2,column:54},end:{line:45,column:3}},line:2},"2":{name:"(anonymous_2)",decl:{start:{line:8,column:20},end:{line:8,column:21}},loc:{start:{line:8,column:49},end:{line:44,column:5}},line:8},"3":{name:"(anonymous_3)",decl:{start:{line:12,column:33},end:{line:12,column:34}},loc:{start:{line:12,column:54},end:{line:43,column:7}},line:12}},branchMap:{"0":{loc:{start:{line:15,column:8},end:{line:22,column:9}},type:"if",locations:[{start:{line:15,column:8},end:{line:22,column:9}},{start:{line:15,column:8},end:{line:22,column:9}}],line:15},"1":{loc:{start:{line:27,column:8},end:{line:42,column:9}},type:"if",locations:[{start:{line:27,column:8},end:{line:42,column:9}},{start:{line:27,column:8},end:{line:42,column:9}}],line:27}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0},f:{"0":0,"1":0,"2":0,"3":0},b:{"0":[0,0],"1":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"4cc0b7fa956af38d60aa4756b6c8d567e788868b"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];{// @ts-ignore
cov_x511qlpzq=function(){return actualCoverage;};}return actualCoverage;}cov_x511qlpzq();cov_x511qlpzq().s[0]++;module.exports=function(db,app,formidable,client,fs,path){cov_x511qlpzq().f[0]++;cov_x511qlpzq().s[1]++;app.post('/profileImage',async function(req,res){cov_x511qlpzq().f[1]++;cov_x511qlpzq().s[2]++;await client.connect();var form=(cov_x511qlpzq().s[3]++,new formidable.IncomingForm());const uploadFolder=(cov_x511qlpzq().s[4]++,path.join(__dirname,"../image"));cov_x511qlpzq().s[5]++;form.uploadDir=uploadFolder;cov_x511qlpzq().s[6]++;form.keepExtensions=true;cov_x511qlpzq().s[7]++;form.parse(req,async(err,fields,files)=>{cov_x511qlpzq().f[2]++;//assuming a single file for this example.
let oldpath=(cov_x511qlpzq().s[8]++,files.image[0].filepath);let newpath=(cov_x511qlpzq().s[9]++,path.join(form.uploadDir,files.image[0].originalFilename));cov_x511qlpzq().s[10]++;fs.rename(oldpath,newpath,async function(err){cov_x511qlpzq().f[3]++;//if an error occurs send message to client
const userId=(cov_x511qlpzq().s[11]++,Number(fields.userId));cov_x511qlpzq().s[12]++;if(err){cov_x511qlpzq().b[0][0]++;cov_x511qlpzq().s[13]++;console.log("Error parsing the files");cov_x511qlpzq().s[14]++;return res.status(400).json({status:"Fail",message:"There was an error parsing the files",error:err});}else{cov_x511qlpzq().b[0][1]++;}const result=(cov_x511qlpzq().s[15]++,await db.collection('users').updateOne({userid:userId},{$set:{filename:files.image[0].originalFilename}}));cov_x511qlpzq().s[16]++;if(result.modifiedCount===1){cov_x511qlpzq().b[1][0]++;let user=(cov_x511qlpzq().s[17]++,await db.collection('users').findOne({userid:userId}));const responseData=(cov_x511qlpzq().s[18]++,{userid:user.userid,username:user.username,roles:user.roles,filename:user.filename});cov_x511qlpzq().s[19]++;res.send({valid:true,user:responseData,data:{'filename':files.image[0].originalFilename,'size':files.image[0].size}});}else{cov_x511qlpzq().b[1][1]++;cov_x511qlpzq().s[20]++;res.send({success:false});}});});});};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfeDUxMXFscHpxIiwiYWN0dWFsQ292ZXJhZ2UiLCJzIiwibW9kdWxlIiwiZXhwb3J0cyIsImRiIiwiYXBwIiwiZm9ybWlkYWJsZSIsImNsaWVudCIsImZzIiwicGF0aCIsImYiLCJwb3N0IiwicmVxIiwicmVzIiwiY29ubmVjdCIsImZvcm0iLCJJbmNvbWluZ0Zvcm0iLCJ1cGxvYWRGb2xkZXIiLCJqb2luIiwiX19kaXJuYW1lIiwidXBsb2FkRGlyIiwia2VlcEV4dGVuc2lvbnMiLCJwYXJzZSIsImVyciIsImZpZWxkcyIsImZpbGVzIiwib2xkcGF0aCIsImltYWdlIiwiZmlsZXBhdGgiLCJuZXdwYXRoIiwib3JpZ2luYWxGaWxlbmFtZSIsInJlbmFtZSIsInVzZXJJZCIsIk51bWJlciIsImIiLCJjb25zb2xlIiwibG9nIiwic3RhdHVzIiwianNvbiIsIm1lc3NhZ2UiLCJlcnJvciIsInJlc3VsdCIsImNvbGxlY3Rpb24iLCJ1cGRhdGVPbmUiLCJ1c2VyaWQiLCIkc2V0IiwiZmlsZW5hbWUiLCJtb2RpZmllZENvdW50IiwidXNlciIsImZpbmRPbmUiLCJyZXNwb25zZURhdGEiLCJ1c2VybmFtZSIsInJvbGVzIiwic2VuZCIsInZhbGlkIiwiZGF0YSIsInNpemUiLCJzdWNjZXNzIl0sInNvdXJjZXMiOlsidXBsb2Fkcy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKCBkYiAsYXBwLGZvcm1pZGFibGUgLGNsaWVudCxmcyxwYXRoKXtcclxuICBhcHAucG9zdCgnL3Byb2ZpbGVJbWFnZScsIGFzeW5jIGZ1bmN0aW9uIChyZXEsIHJlcykge1xyXG4gICAgYXdhaXQgY2xpZW50LmNvbm5lY3QoKTtcclxuICAgIHZhciBmb3JtID0gbmV3IGZvcm1pZGFibGUuSW5jb21pbmdGb3JtKCk7XHJcbiAgICBjb25zdCB1cGxvYWRGb2xkZXIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2ltYWdlXCIpO1xyXG4gICAgZm9ybS51cGxvYWREaXIgPSB1cGxvYWRGb2xkZXI7XHJcbiAgICBmb3JtLmtlZXBFeHRlbnNpb25zID0gdHJ1ZTtcclxuICAgIGZvcm0ucGFyc2UocmVxLCBhc3luYyAoZXJyLCBmaWVsZHMsIGZpbGVzKT0+IHtcclxuICAgICAgLy9hc3N1bWluZyBhIHNpbmdsZSBmaWxlIGZvciB0aGlzIGV4YW1wbGUuXHJcbiAgICAgIGxldCBvbGRwYXRoID0gZmlsZXMuaW1hZ2VbMF0uZmlsZXBhdGg7XHJcbiAgICAgIGxldCBuZXdwYXRoID0gcGF0aC5qb2luKGZvcm0udXBsb2FkRGlyLCBmaWxlcy5pbWFnZVswXS5vcmlnaW5hbEZpbGVuYW1lKTtcclxuICAgICAgZnMucmVuYW1lKG9sZHBhdGgsIG5ld3BhdGgsYXN5bmMgZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgIC8vaWYgYW4gZXJyb3Igb2NjdXJzIHNlbmQgbWVzc2FnZSB0byBjbGllbnRcclxuICAgICAgICBjb25zdCB1c2VySWQgPSBOdW1iZXIoZmllbGRzLnVzZXJJZCk7XHJcbiAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coXCJFcnJvciBwYXJzaW5nIHRoZSBmaWxlc1wiKTtcclxuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN0YXR1czogXCJGYWlsXCIsXHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IFwiVGhlcmUgd2FzIGFuIGVycm9yIHBhcnNpbmcgdGhlIGZpbGVzXCIsXHJcbiAgICAgICAgICAgIGVycm9yOiBlcnIsXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGIuY29sbGVjdGlvbigndXNlcnMnKS51cGRhdGVPbmUoXHJcbiAgICAgICAgICB7IHVzZXJpZDogdXNlcklkIH0sXHJcbiAgICAgICAgICB7ICRzZXQ6IHsgZmlsZW5hbWU6IGZpbGVzLmltYWdlWzBdLm9yaWdpbmFsRmlsZW5hbWUgfSB9XHJcbiAgICAgICAgKTtcclxuICAgICAgICBpZiAocmVzdWx0Lm1vZGlmaWVkQ291bnQgPT09IDEpIHtcclxuICAgICAgICAgIGxldCB1c2VyID0gYXdhaXQgZGIuY29sbGVjdGlvbigndXNlcnMnKS5maW5kT25lKHsgdXNlcmlkOiB1c2VySWQgfSlcclxuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlRGF0YSA9IHtcclxuICAgICAgICAgICAgdXNlcmlkOiB1c2VyLnVzZXJpZCxcclxuICAgICAgICAgICAgdXNlcm5hbWU6IHVzZXIudXNlcm5hbWUsXHJcbiAgICAgICAgICAgIHJvbGVzOiB1c2VyLnJvbGVzLFxyXG4gICAgICAgICAgICBmaWxlbmFtZTp1c2VyLmZpbGVuYW1lXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgcmVzLnNlbmQoe1xyXG4gICAgICAgICAgICB2YWxpZDogdHJ1ZSxcclxuICAgICAgICAgICAgdXNlcjogcmVzcG9uc2VEYXRhLCAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgZGF0YTp7J2ZpbGVuYW1lJzpmaWxlcy5pbWFnZVswXS5vcmlnaW5hbEZpbGVuYW1lLCdzaXplJzpmaWxlcy5pbWFnZVswXS5zaXplfSxcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXMuc2VuZCh7IHN1Y2Nlc3M6IGZhbHNlIH0pO1xyXG4gICAgICAgIH0gICAgXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn0iXSwibWFwcGluZ3MiOiJrNEZBZVk7QUFBQUEsYUFBQSxTQUFBQSxDQUFBLFNBQUFDLGNBQUEsV0FBQUEsY0FBQSxFQUFBRCxhQUFBLEdBQUFBLGFBQUEsR0FBQUUsQ0FBQSxNQWZaQyxNQUFNLENBQUNDLE9BQU8sQ0FBRyxTQUFVQyxFQUFFLENBQUVDLEdBQUcsQ0FBQ0MsVUFBVSxDQUFFQyxNQUFNLENBQUNDLEVBQUUsQ0FBQ0MsSUFBSSxDQUFDLENBQUFWLGFBQUEsR0FBQVcsQ0FBQSxNQUFB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